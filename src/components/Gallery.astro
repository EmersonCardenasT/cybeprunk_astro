---
// Gallery.astro — Galería Bento · Minimal · Steel / Olive
---

<section id="galeria" class="gal-section">

  <div class="gal-bg" aria-hidden="true">
    <div class="gal-grain"></div>
    <div class="gal-line gal-line-top"></div>
    <div class="gal-line gal-line-bottom"></div>
  </div>

  <div class="gal-inner">

    <!-- ══ HEADER ══ -->
    <div class="gal-header" data-reveal>
      <div class="gal-header-left">
        <p class="gal-eyebrow">
          <span class="eyebrow-pip"></span>
          Galería
        </p>
        <h2 class="gal-title">
          Nuestro<br/>
          <span class="title-outline">trabajo.</span>
        </h2>
      </div>
      <div class="gal-header-right">
        <p class="gal-sub">
          Reparaciones, equipos, clientes satisfechos. Cada imagen cuenta parte de lo que hacemos cada día.
        </p>
        <div class="gal-filters" role="tablist">
          <button class="gal-filter active" data-filter="all"       role="tab" aria-selected="true">Todo</button>
          <button class="gal-filter"        data-filter="equipos"   role="tab" aria-selected="false">Equipos</button>
          <button class="gal-filter"        data-filter="reparacion" role="tab" aria-selected="false">Reparaciones</button>
          <button class="gal-filter"        data-filter="tienda"    role="tab" aria-selected="false">Tienda</button>
        </div>
      </div>
    </div>

    <!-- ══ BENTO GRID ══ -->
    <div class="gal-bento" id="galBento" data-reveal>

      <!-- [A] WIDE — iPhone lineup hero -->
      <div class="gal-item gal-a" data-cat="equipos">
        <div class="gal-img-wrap">
          <img src="https://images.unsplash.com/photo-1512054502232-10a0a035d672?w=1200&q=80&auto=format&fit=crop" alt="Lineup de iPhones" class="gal-img" loading="lazy"/>
          <div class="gal-overlay"></div>
        </div>
        <div class="gal-caption">
          <span class="gal-caption-cat">Equipos</span>
          <span class="gal-caption-title">Lineup iPhone · Serie 15 & 16</span>
        </div>
        <div class="gal-item-accent"></div>
      </div>

      <!-- [B] TALL — repair workshop -->
      <div class="gal-item gal-b" data-cat="reparacion">
        <div class="gal-img-wrap">
          <img src="https://images.unsplash.com/photo-1581092160607-ee22621dd758?w=900&q=80&auto=format&fit=crop&crop=center" alt="Taller de reparación" class="gal-img" loading="lazy"/>
          <div class="gal-overlay"></div>
        </div>
        <div class="gal-caption">
          <span class="gal-caption-cat">Reparación</span>
          <span class="gal-caption-title">Taller de precisión</span>
        </div>
        <div class="gal-item-accent"></div>
      </div>

      <!-- [C] SQUARE — Samsung Galaxy -->
      <div class="gal-item gal-c" data-cat="equipos">
        <div class="gal-img-wrap">
          <img src="https://images.unsplash.com/photo-1610945415295-d9bbf067e59c?w=800&q=80&auto=format&fit=crop" alt="Samsung Galaxy S24 Ultra" class="gal-img" loading="lazy"/>
          <div class="gal-overlay"></div>
        </div>
        <div class="gal-caption">
          <span class="gal-caption-cat">Equipos</span>
          <span class="gal-caption-title">Samsung Galaxy S24 Ultra</span>
        </div>
        <div class="gal-item-accent"></div>
      </div>

      <!-- [D] SQUARE — screen replacement -->
      <div class="gal-item gal-d" data-cat="reparacion">
        <div class="gal-img-wrap">
          <img src="https://images.unsplash.com/photo-1601597111158-2fceff292cdc?w=800&q=80&auto=format&fit=crop" alt="Cambio de pantalla" class="gal-img" loading="lazy"/>
          <div class="gal-overlay"></div>
        </div>
        <div class="gal-caption">
          <span class="gal-caption-cat">Reparación</span>
          <span class="gal-caption-title">Cambio de pantalla</span>
        </div>
        <div class="gal-item-accent"></div>
      </div>

      <!-- [E] WIDE — store interior -->
      <div class="gal-item gal-e" data-cat="tienda">
        <div class="gal-img-wrap">
          <img src="https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?w=1200&q=80&auto=format&fit=crop" alt="Interior de la tienda CellTech" class="gal-img" loading="lazy"/>
          <div class="gal-overlay"></div>
        </div>
        <div class="gal-caption">
          <span class="gal-caption-cat">Tienda</span>
          <span class="gal-caption-title">Atención personalizada</span>
        </div>
        <div class="gal-item-accent"></div>
      </div>

      <!-- [F] TALL — tech desk setup -->
      <div class="gal-item gal-f" data-cat="tienda">
        <div class="gal-img-wrap">
          <img src="https://images.unsplash.com/photo-1518770660439-4636190af475?w=900&q=80&auto=format&fit=crop" alt="Mesa de trabajo técnico" class="gal-img" loading="lazy"/>
          <div class="gal-overlay"></div>
        </div>
        <div class="gal-caption">
          <span class="gal-caption-cat">Tienda</span>
          <span class="gal-caption-title">Mesa de trabajo</span>
        </div>
        <div class="gal-item-accent"></div>
      </div>

      <!-- [G] SQUARE — accessories & covers -->
      <div class="gal-item gal-g" data-cat="equipos">
        <div class="gal-img-wrap">
          <img src="https://images.unsplash.com/photo-1583573636842-5cee1c94a85e?w=800&q=80&auto=format&fit=crop" alt="Accesorios y covers" class="gal-img" loading="lazy"/>
          <div class="gal-overlay"></div>
        </div>
        <div class="gal-caption">
          <span class="gal-caption-cat">Equipos</span>
          <span class="gal-caption-title">Accesorios certificados</span>
        </div>
        <div class="gal-item-accent"></div>
      </div>

      <!-- [H] SQUARE — battery replacement -->
      <div class="gal-item gal-h" data-cat="reparacion">
        <div class="gal-img-wrap">
          <img src="https://images.unsplash.com/photo-1626428091554-5f55a4a1a92b?w=800&q=80&auto=format&fit=crop" alt="Cambio de batería" class="gal-img" loading="lazy"/>
          <div class="gal-overlay"></div>
        </div>
        <div class="gal-caption">
          <span class="gal-caption-cat">Reparación</span>
          <span class="gal-caption-title">Reemplazo de batería</span>
        </div>
        <div class="gal-item-accent"></div>
      </div>

      <!-- [I] SQUARE — Xiaomi -->
      <div class="gal-item gal-i" data-cat="equipos">
        <div class="gal-img-wrap">
          <img src="https://images.unsplash.com/photo-1551355738-a7f40c0f2d18?w=800&q=80&auto=format&fit=crop" alt="Xiaomi 13T Pro" class="gal-img" loading="lazy"/>
          <div class="gal-overlay"></div>
        </div>
        <div class="gal-caption">
          <span class="gal-caption-cat">Equipos</span>
          <span class="gal-caption-title">Xiaomi · Gama alta</span>
        </div>
        <div class="gal-item-accent"></div>
      </div>

      

    </div>
    <!-- /gal-bento -->

    <!-- ══ FOOTER ══ -->
    <div class="gal-footer" data-reveal>
      <span class="gal-footer-note">
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
          <rect x="1" y="1" width="10" height="10" rx="1.5" stroke="currentColor" stroke-width="1"/>
          <circle cx="4" cy="4" r="1" fill="currentColor" opacity="0.5"/>
          <path d="M1 8l3-3 2 2 2-3 3 4" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Fotos reales de nuestro local y trabajo diario
      </span>
      <a href="#contacto" class="gal-footer-cta">
        Visitanos y conocé el equipo
        <svg width="13" height="13" viewBox="0 0 13 13" fill="none">
          <path d="M3 6.5h7M7 3.5l3 3-3 3" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </a>
    </div>

  </div>
</section>

<!-- ── LIGHTBOX ── -->
<div class="gal-lightbox" id="galLightbox" role="dialog" aria-modal="true" aria-label="Visor de imagen" hidden>
  <div class="gal-lb-backdrop" id="galLbBackdrop"></div>
  <div class="gal-lb-content">
    <button class="gal-lb-close" id="galLbClose" aria-label="Cerrar">
      <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
        <path d="M2 2l14 14M16 2L2 16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
    </button>
    <img src="" alt="" class="gal-lb-img" id="galLbImg"/>
    <div class="gal-lb-info">
      <span class="gal-lb-cat" id="galLbCat"></span>
      <span class="gal-lb-title" id="galLbTitle"></span>
    </div>
    <button class="gal-lb-nav gal-lb-prev" id="galLbPrev" aria-label="Anterior">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
        <path d="M10 3L5 8l5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <button class="gal-lb-nav gal-lb-next" id="galLbNext" aria-label="Siguiente">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
        <path d="M6 3l5 5-5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>
</div>

<style>
  :root {
    --steel:    #4a6278;
    --steel-lt: #7a98ae;
    --olive:    #6b7c55;
    --olive-lt: #8fa070;
    --white:    #f4f3ef;
    --black:    #0a0a0a;
  }

  .gal-section {
    --bg:      #f4f3ef; --bg-card: #ffffff;
    --text:    #0a0a0a; --muted:   rgba(10,10,10,0.42);
    --border:  rgba(10,10,10,0.08);
    background: var(--bg); color: var(--text);
    position: relative; padding: 120px 0 100px;
    font-family: 'DM Sans', 'Helvetica Neue', sans-serif;
    overflow: hidden; transition: background 0.4s, color 0.4s;
  }
  :root.dark .gal-section {
    --bg: #0c0c0c; --bg-card: #111111;
    --text: #f4f3ef; --muted: rgba(244,243,239,0.38);
    --border: rgba(244,243,239,0.07);
  }
  :root.dark .title-outline { -webkit-text-stroke: 1px rgba(244,243,239,0.28) !important; }

  .gal-bg { position: absolute; inset: 0; pointer-events: none; }
  .gal-grain {
    position: absolute; inset: 0; opacity: 0.025;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='g'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23g)'/%3E%3C/svg%3E");
    background-size: 256px;
  }
  .gal-line { position: absolute; left:0; right:0; height:1px; background:var(--border); }
  .gal-line-top { top:0; } .gal-line-bottom { bottom:0; }

  .gal-inner {
    max-width: 1280px; margin: 0 auto; padding: 0 44px;
    display: flex; flex-direction: column; gap: 48px;
    position: relative; z-index: 1;
  }
  @media (max-width: 640px) { .gal-inner { padding: 0 20px; gap: 36px; } }

  /* ── HEADER ── */
  .gal-header {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 60px; align-items: end;
  }
  @media (max-width: 860px) { .gal-header { grid-template-columns: 1fr; gap: 24px; } }

  .gal-header-left { display: flex; flex-direction: column; gap: 14px; }
  .gal-eyebrow {
    display: flex; align-items: center; gap: 10px;
    font-size: 0.65rem; letter-spacing: 0.26em;
    text-transform: uppercase; color: var(--steel-lt); margin: 0;
  }
  .eyebrow-pip {
    width: 7px; height: 7px; background: var(--olive-lt);
    border-radius: 50%; box-shadow: 0 0 8px var(--olive); flex-shrink: 0;
  }
  .gal-title {
    font-family: 'DM Serif Display', Georgia, serif;
    font-size: clamp(2.4rem, 5vw, 4rem);
    font-weight: 400; line-height: 0.93;
    letter-spacing: -0.035em; color: var(--text); margin: 0;
  }
  .title-outline { color: transparent; -webkit-text-stroke: 1px rgba(10,10,10,0.35); }

  .gal-header-right { display: flex; flex-direction: column; gap: 20px; }
  .gal-sub {
    font-size: 0.88rem; color: var(--muted); line-height: 1.75;
    margin: 0; font-weight: 300;
  }
  .gal-filters { display: flex; gap: 4px; flex-wrap: wrap; }
  .gal-filter {
    padding: 7px 18px; font-size: 0.63rem; font-weight: 500;
    letter-spacing: 0.15em; text-transform: uppercase;
    border: 1px solid var(--border); background: transparent;
    color: var(--muted); cursor: pointer;
    transition: border-color 0.25s, color 0.25s, background 0.25s, box-shadow 0.25s;
  }
  .gal-filter:hover { border-color: var(--steel-lt); color: var(--text); }
  .gal-filter.active {
    border-color: var(--steel); color: var(--text);
    background: rgba(74,98,120,0.07);
    box-shadow: 0 0 14px rgba(74,98,120,0.1);
  }

  /* ══ BENTO GRID ══
     12-column base, 2px gap
     Row heights: 260px + 260px = 520px top block
                  320px bottom block
  */
  .gal-bento {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    grid-template-rows: 260px 260px 320px;
    gap: 2px;
  }
  @media (max-width: 900px) {
    .gal-bento {
      grid-template-columns: repeat(6, 1fr);
      grid-template-rows: repeat(auto-fill, 220px);
    }
  }
  @media (max-width: 560px) {
    .gal-bento {
      grid-template-columns: 1fr 1fr;
      grid-template-rows: repeat(auto-fill, 180px);
    }
  }

  /* Grid placement — desktop 12-col */
  /* Row 1+2 */
  .gal-a { grid-column: 1 / 8;  grid-row: 1 / 2; } /* wide */
  .gal-b { grid-column: 8 / 10; grid-row: 1 / 3; } /* tall 2 rows */
  .gal-c { grid-column: 10 / 13;grid-row: 1 / 2; } /* square */
  .gal-d { grid-column: 1 / 4;  grid-row: 2 / 3; } /* square */
  .gal-e { grid-column: 4 / 8;  grid-row: 2 / 3; } /* wide */
  .gal-f { grid-column: 10 / 13;grid-row: 2 / 3; } /* square */
  /* Row 3 */
  .gal-g { grid-column: 1 / 4;  grid-row: 3 / 4; }
  .gal-h { grid-column: 4 / 7;  grid-row: 3 / 4; }
  .gal-i { grid-column: 7 / 10; grid-row: 3 / 4; }

  /* Tablet override (6-col) */
  @media (max-width: 900px) {
    .gal-a { grid-column: 1 / 5; grid-row: 1 / 2; }
    .gal-b { grid-column: 5 / 7; grid-row: 1 / 3; }
    .gal-c { grid-column: 1 / 3; grid-row: 2 / 3; }
    .gal-d { grid-column: 3 / 5; grid-row: 2 / 3; }
    .gal-e { grid-column: 1 / 4; grid-row: 3 / 4; }
    .gal-f { grid-column: 4 / 7; grid-row: 3 / 4; }
    .gal-g { grid-column: 1 / 3; grid-row: 4 / 5; }
    .gal-h { grid-column: 3 / 5; grid-row: 4 / 5; }
    .gal-i { grid-column: 5 / 7; grid-row: 4 / 5; }
  }
  /* Mobile (2-col) */
  @media (max-width: 560px) {
    .gal-a, .gal-b, .gal-c, .gal-d, .gal-e,
    .gal-f, .gal-g, .gal-h, .gal-i {
      grid-column: auto; grid-row: auto;
    }
    .gal-a { grid-column: 1 / 3; } /* wide on mobile */
    .gal-e { grid-column: 1 / 3; } /* wide on mobile */
  }

  /* ── ITEM ── */
  .gal-item {
    position: relative; overflow: hidden;
    cursor: pointer; display: block;
    background: var(--bg-card);
  }

  .gal-img-wrap { position: absolute; inset: 0; }
  .gal-img {
    width: 100%; height: 100%; object-fit: cover;
    display: block;
    transition: transform 0.65s cubic-bezier(0.22,1,0.36,1),
                filter 0.4s;
    filter: saturate(0.92) brightness(0.96);
  }
  .gal-item:hover .gal-img {
    transform: scale(1.06);
    filter: saturate(1) brightness(1);
  }

  /* Overlay always present, deepens on hover */
  .gal-overlay {
    position: absolute; inset: 0;
    background:
      linear-gradient(180deg, transparent 40%, rgba(6,6,6,0.72) 100%);
    opacity: 0.7;
    transition: opacity 0.4s;
  }
  .gal-item:hover .gal-overlay { opacity: 0.9; }

  /* Caption slides up on hover */
  .gal-caption {
    position: absolute; bottom: 0; left: 0; right: 0;
    padding: 20px 20px 18px;
    display: flex; flex-direction: column; gap: 4px;
    transform: translateY(6px);
    transition: transform 0.4s cubic-bezier(0.22,1,0.36,1);
    z-index: 1;
  }
  .gal-item:hover .gal-caption { transform: translateY(0); }

  .gal-caption-cat {
    font-size: 0.52rem; font-weight: 700;
    letter-spacing: 0.2em; text-transform: uppercase;
    color: var(--olive-lt); line-height: 1;
  }
  .gal-caption-title {
    font-size: 0.82rem; font-weight: 400;
    color: rgba(244,243,239,0.9); line-height: 1.3;
  }

  /* Accent bottom bar */
  .gal-item-accent {
    position: absolute; bottom: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(to right, var(--olive), var(--steel));
    transform: scaleX(0); transform-origin: left;
    transition: transform 0.45s cubic-bezier(0.4,0,0.2,1);
    z-index: 2;
  }
  .gal-item:hover .gal-item-accent { transform: scaleX(1); }

  /* Filter hidden state */
  .gal-item.hidden {
    opacity: 0; pointer-events: none;
    /* keep in grid but invisible */
  }

  /* ── FOOTER ── */
  .gal-footer {
    display: flex; align-items: center;
    justify-content: space-between; flex-wrap: wrap; gap: 14px;
  }
  .gal-footer-note {
    display: flex; align-items: center; gap: 7px;
    font-size: 0.63rem; letter-spacing: 0.1em; color: var(--muted);
  }
  .gal-footer-note svg { color: var(--steel-lt); flex-shrink: 0; }
  .gal-footer-cta {
    display: inline-flex; align-items: center; gap: 7px;
    font-size: 0.65rem; font-weight: 500;
    letter-spacing: 0.18em; text-transform: uppercase;
    text-decoration: none; color: var(--muted);
    transition: color 0.25s, gap 0.25s;
  }
  .gal-footer-cta:hover { color: var(--steel-lt); gap: 11px; }

  /* ══ LIGHTBOX ══ */
  .gal-lightbox {
    position: fixed; inset: 0; z-index: 1000;
    display: flex; align-items: center; justify-content: center;
    animation: lbFadeIn 0.25s ease both;
  }
  .gal-lightbox[hidden] { display: none; }

  @keyframes lbFadeIn {
    from { opacity: 0; } to { opacity: 1; }
  }

  .gal-lb-backdrop {
    position: absolute; inset: 0;
    background: rgba(6,6,6,0.94);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    cursor: pointer;
  }

  .gal-lb-content {
    position: relative; z-index: 1;
    display: flex; flex-direction: column;
    align-items: center; gap: 16px;
    max-width: min(90vw, 900px);
    padding: 20px;
    animation: lbSlideUp 0.3s cubic-bezier(0.22,1,0.36,1) both;
  }
  @keyframes lbSlideUp {
    from { transform: translateY(20px); opacity: 0; }
    to   { transform: translateY(0);    opacity: 1; }
  }

  .gal-lb-img {
    max-height: 70vh; max-width: 100%;
    object-fit: contain; display: block;
    border: 1px solid rgba(244,243,239,0.07);
  }

  .gal-lb-info {
    display: flex; align-items: center; gap: 12px;
  }
  .gal-lb-cat {
    font-size: 0.55rem; font-weight: 700;
    letter-spacing: 0.22em; text-transform: uppercase;
    color: var(--olive-lt);
    border: 1px solid rgba(107,124,85,0.3); padding: 3px 9px;
  }
  .gal-lb-title {
    font-size: 0.8rem; color: rgba(244,243,239,0.6);
    font-weight: 300; letter-spacing: 0.06em;
  }

  .gal-lb-close {
    position: absolute; top: -8px; right: -8px;
    width: 36px; height: 36px;
    display: flex; align-items: center; justify-content: center;
    background: rgba(244,243,239,0.08);
    border: 1px solid rgba(244,243,239,0.12);
    color: rgba(244,243,239,0.7); cursor: pointer;
    transition: background 0.2s, color 0.2s;
    z-index: 2;
  }
  .gal-lb-close:hover { background: rgba(244,243,239,0.15); color: var(--white); }

  .gal-lb-nav {
    position: fixed; top: 50%; transform: translateY(-50%);
    width: 44px; height: 44px;
    display: flex; align-items: center; justify-content: center;
    background: rgba(244,243,239,0.06);
    border: 1px solid rgba(244,243,239,0.1);
    color: rgba(244,243,239,0.6); cursor: pointer;
    transition: background 0.2s, color 0.2s, transform 0.2s;
  }
  .gal-lb-prev { left: 20px; }
  .gal-lb-next { right: 20px; }
  .gal-lb-nav:hover {
    background: rgba(74,98,120,0.25);
    color: var(--white);
    border-color: var(--steel);
  }
  .gal-lb-prev:hover { transform: translateY(-50%) translateX(-2px); }
  .gal-lb-next:hover { transform: translateY(-50%) translateX(2px); }

  /* ── REVEAL ── */
  [data-reveal] {
    opacity: 0; transform: translateY(22px);
    transition: opacity 0.75s cubic-bezier(0.22,1,0.36,1), transform 0.75s cubic-bezier(0.22,1,0.36,1);
  }
  [data-reveal].visible { opacity: 1; transform: translateY(0); }
  .gal-bento[data-reveal]  { transition-delay: 0.1s; }
  .gal-footer[data-reveal] { transition-delay: 0.2s; }
</style>

<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Serif+Display&display=swap" rel="stylesheet"/>

<script>
(function () {
  /* ── REVEAL ── */
  const revealObs = new IntersectionObserver(
    entries => entries.forEach(e => {
      if (e.isIntersecting) { e.target.classList.add('visible'); revealObs.unobserve(e.target); }
    }), { threshold: 0.06, rootMargin: '0px 0px -30px 0px' }
  );
  document.querySelectorAll('[data-reveal]').forEach(el => revealObs.observe(el));

  /* ── FILTER ── */
  const filters = document.querySelectorAll('.gal-filter');
  const items   = document.querySelectorAll<HTMLElement>('.gal-item');

  filters.forEach(btn => {
    btn.addEventListener('click', () => {
      filters.forEach(b => { b.classList.remove('active'); b.setAttribute('aria-selected','false'); });
      btn.classList.add('active');
      btn.setAttribute('aria-selected','true');
      const f = (btn as HTMLElement).dataset.filter;
      items.forEach(item => {
        const match = f === 'all' || item.dataset.cat === f;
        item.classList.toggle('hidden', !match);
        item.style.opacity = match ? '1' : '0';
        item.style.pointerEvents = match ? '' : 'none';
        item.style.transition = 'opacity 0.4s';
      });
    });
  });

  /* ── LIGHTBOX ── */
  const lb        = document.getElementById('galLightbox') as HTMLElement;
  const lbImg     = document.getElementById('galLbImg')    as HTMLImageElement;
  const lbCat     = document.getElementById('galLbCat')    as HTMLElement;
  const lbTitle   = document.getElementById('galLbTitle')  as HTMLElement;
  const lbClose   = document.getElementById('galLbClose');
  const lbBackdrop= document.getElementById('galLbBackdrop');
  const lbPrev    = document.getElementById('galLbPrev');
  const lbNext    = document.getElementById('galLbNext');

  let visibleItems: HTMLElement[] = [];
  let currentIdx = 0;

  function getVisible(): HTMLElement[] {
    return Array.from(items).filter(i => !i.classList.contains('hidden'));
  }

  function openLb(item: HTMLElement) {
    visibleItems = getVisible();
    currentIdx   = visibleItems.indexOf(item);
    showLbItem(currentIdx);
    lb.removeAttribute('hidden');
    document.body.style.overflow = 'hidden';
  }

  function showLbItem(idx: number) {
    const item  = visibleItems[idx];
    const img   = item.querySelector<HTMLImageElement>('.gal-img');
    const cat   = item.querySelector('.gal-caption-cat');
    const title = item.querySelector('.gal-caption-title');
    if (!img) return;
    lbImg.src          = img.src.replace(/w=\d+/, 'w=1200');
    lbImg.alt          = img.alt;
    lbCat.textContent  = cat?.textContent ?? '';
    lbTitle.textContent= title?.textContent ?? '';
    currentIdx = idx;
    if (lbPrev) (lbPrev as HTMLButtonElement).disabled = idx === 0;
    if (lbNext) (lbNext as HTMLButtonElement).disabled = idx === visibleItems.length - 1;
  }

  function closeLb() {
    lb.setAttribute('hidden', '');
    document.body.style.overflow = '';
  }

  items.forEach(item => {
    item.addEventListener('click', () => openLb(item));
    item.setAttribute('tabindex', '0');
    item.setAttribute('role', 'button');
    item.setAttribute('aria-label', item.querySelector('.gal-caption-title')?.textContent ?? 'Ver imagen');
    item.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') openLb(item); });
  });

  lbClose?.addEventListener('click',    closeLb);
  lbBackdrop?.addEventListener('click', closeLb);
  lbPrev?.addEventListener('click', () => { if (currentIdx > 0) showLbItem(currentIdx - 1); });
  lbNext?.addEventListener('click', () => { if (currentIdx < visibleItems.length - 1) showLbItem(currentIdx + 1); });

  document.addEventListener('keydown', e => {
    if (lb.hasAttribute('hidden')) return;
    if (e.key === 'Escape')     closeLb();
    if (e.key === 'ArrowLeft'  && currentIdx > 0)                    showLbItem(currentIdx - 1);
    if (e.key === 'ArrowRight' && currentIdx < visibleItems.length-1) showLbItem(currentIdx + 1);
  });
})();
</script>